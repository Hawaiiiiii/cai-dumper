"use strict";var ae=Object.defineProperty;var se=(n,e,t)=>e in n?ae(n,e,{enumerable:!0,configurable:!0,writable:!0,value:t}):n[e]=t;var N=(n,e,t)=>se(n,typeof e!="symbol"?e+"":e,t);const w=require("electron"),T=require("path"),I=require("fs"),te=require("playwright"),ie=require("child_process");class oe{constructor(e,t,r){N(this,"browserContext",null);N(this,"page",null);N(this,"userDataDir");N(this,"cacheDir");N(this,"logCallback");N(this,"verboseSanitizeLogs");this.userDataDir=e,this.cacheDir=r||T.join(e,"cache"),this.logCallback=t,this.verboseSanitizeLogs=/^(1|true|yes|on)$/i.test(process.env.CAI_DUMPER_VERBOSE_SANITIZE||"")}log(e){console.log(`[Scraper] ${e}`),this.logCallback(e)}sanitizeText(e,t){if(e==null)return null;if(typeof e!="string")return this.verboseSanitizeLogs&&this.log(`[sanitize] drop non-string ${t.field} (${typeof e}) ${t.url||""}`),null;let r=e;if(r=r.replace(/\r\n/g,`
`),r=r.replace(/[\t\f\v]/g," "),r=r.replace(/\u00a0/g," "),r=r.replace(/\s+/g," ").trim(),!r)return null;const s=r.toLowerCase();if(["toast-container","toastify","react-toastify","css","{","}","style=","<style","</style","animation:","@keyframes"].some(i=>s.includes(i)))return this.verboseSanitizeLogs&&this.log(`[sanitize] drop noisy ${t.field}: ${JSON.stringify(r.slice(0,160))} ${t.url||""}`),null;const a=t.maxLen??300;if(r.length>a){const i=r.slice(0,a).trim();this.verboseSanitizeLogs&&this.log(`[sanitize] clip ${t.field} ${r.length}→${i.length} ${t.url||""}`),r=i}return r||null}isValidHandle(e){return e?/^@[A-Za-z0-9_]{2,32}$/.test(e.trim()):!1}qualityGateText(e,t){var g;if(!e)return null;const r=e.toLowerCase();if(["toastify","@keyframes",":root","{","}"].some(u=>r.includes(u)))return this.verboseSanitizeLogs&&this.log(`[quality] drop banned ${t.field}: ${JSON.stringify(e.slice(0,160))} ${t.url||""}`),null;const l=e.length,a=((g=e.match(/[A-Za-z0-9\s.,'"!?@#\-_/():;\[\]\\]/g))==null?void 0:g.length)??0,i=l>0?(l-a)/l:0;if(i>.3)return this.verboseSanitizeLogs&&this.log(`[quality] drop weird-ratio ${t.field} ${(i*100).toFixed(1)}% ${t.url||""}`),null;const c=t.maxLen??300;return e.length>c?e.slice(0,c).trim()||null:e}safeText(e,t){return this.qualityGateText(this.sanitizeText(e,t),t)}parseCompactNumber(e){if(!e)return null;const r=e.replace(/[\s,]/g,"").toLowerCase().match(/(-?[0-9]*\.?[0-9]+)(k|m)?/);if(!r)return null;const s=Number(r[1]);return isFinite(s)?r[2]==="k"?Math.round(s*1e3):r[2]==="m"?Math.round(s*1e6):Math.round(s):null}async launch(){this.log("Launching persistent Chromium context...");try{I.existsSync(this.userDataDir)||I.mkdirSync(this.userDataDir,{recursive:!0}),I.existsSync(this.cacheDir)||I.mkdirSync(this.cacheDir,{recursive:!0}),this.browserContext=await te.chromium.launchPersistentContext(this.userDataDir,{headless:!1,viewport:null,args:["--start-maximized","--disable-blink-features=AutomationControlled",`--disk-cache-dir=${this.cacheDir}`,"--disable-gpu-cache"]})}catch(e){this.log(`Warning: Failed to create cache/user data dir (${e.message}). Continuing without custom cache.`),this.browserContext=await te.chromium.launchPersistentContext(this.userDataDir,{headless:!1,viewport:null,args:["--start-maximized","--disable-blink-features=AutomationControlled","--disable-gpu-cache"]})}this.page=await this.browserContext.newPage(),await this.page.goto("https://character.ai"),this.log("Browser ready. Please log in manually in the opened window.")}async close(){this.browserContext&&await this.browserContext.close()}async scanSidebar(){var t;if(!this.page)throw new Error("Browser not launched");this.log("Scanning sidebar for chats...");try{await this.page.waitForSelector('a[href*="/chat/"]',{timeout:5e3})}catch{return this.log("No chat links found immediately. Please ensure sidebar is open."),[]}const e=new Map;for(let r=0;r<3;r++){const s=await this.page.$$('a[href*="/chat/"]');this.log(`Found ${s.length} potential chat links (Pass ${r+1})...`);const l=await this.page.evaluate(()=>{const a=Array.from(document.querySelectorAll('a[href*="/chat/"]')),i=o=>{if(!o)return null;const x=o.replace(/[,\s]/g,"").toLowerCase().match(/([0-9\.]+)(k|m)?/);if(!x)return null;const p=parseFloat(x[1]);return isNaN(p)?null:x[2]==="k"?Math.round(p*1e3):x[2]==="m"?Math.round(p*1e6):Math.round(p)},c=["today","yesterday","recent","recently","minute","hour","day"],g=a.map(o=>{const m=o.getAttribute("href")||"",x=m.startsWith("http")?m:`https://character.ai${m}`,p=x.split("/").filter(Boolean).pop()||"unknown",y=(o.innerText||"").split(`
`).map(S=>S.trim()).filter(Boolean),f=y[0]||"Unknown Character",b=y.find((S,A)=>A>0&&S.length>1)||"",L=o.querySelector("img"),E=L?L.getAttribute("src")||L.getAttribute("data-src"):null;let D=null;const M=(o.innerText||"").match(/\bby\s+(@[A-Za-z0-9_]{2,32})\b/i);M?D=M[1]:D=y.find(A=>/^@[A-Za-z0-9_]{2,32}$/.test(A))||null;const C=y.join(" "),k=i(C),_=y.find(S=>c.some(A=>S.toLowerCase().includes(A)))||null;return{characterId:p,chatId:p,displayName:f,creator:D?{handle:D}:null,avatarUrl:E,lastSeenLabel:_,interactions:k,url:x,preview:b,tagline:b,updatedAt:new Date().toISOString()}}),u=new Map;return g.forEach(o=>{u.has(o.chatId)||u.set(o.chatId,o)}),Array.from(u.values())});for(const a of l)if(a.displayName=this.safeText(a.displayName,{field:"sidebar.displayName",url:a.url,maxLen:120})||a.displayName,a.preview=this.safeText(a.preview,{field:"sidebar.preview",url:a.url,maxLen:200})||"",a.tagline=this.safeText(a.tagline,{field:"sidebar.tagline",url:a.url,maxLen:200}),a.lastSeenLabel=this.safeText(a.lastSeenLabel,{field:"sidebar.lastSeenLabel",url:a.url,maxLen:40}),(t=a.creator)!=null&&t.handle){const i=this.safeText(a.creator.handle,{field:"sidebar.creator.handle",url:a.url,maxLen:40});!i||!this.isValidHandle(i)?(this.verboseSanitizeLogs&&this.log(`[sidebar] dropping invalid creator handle ${JSON.stringify(a.creator.handle)} for ${a.chatId}`),a.creator=null):a.creator.handle=i}for(const a of l)e.has(a.chatId)||e.set(a.chatId,a);s.length>0&&(await s[s.length-1].scrollIntoViewIfNeeded(),await this.page.waitForTimeout(1e3))}return Array.from(e.values())}async scanSidebarChatsIndex(){return(await this.scanSidebar()).map(t=>({chatId:t.chatId,chatUrl:t.url,characterName:t.displayName,avatarUrl:t.avatarUrl||null,lastSeenLabel:t.lastSeenLabel||null,updatedAt:new Date().toISOString()}))}normalizeHandle(e){if(!e)return null;const t=e.trim();return t?t.startsWith("@")?t:`@${t}`:null}async scrapeChatHeader(e){if(!this.page)throw new Error("Browser not launched");try{await this.page.goto(e,{waitUntil:"domcontentloaded",timeout:2e4}),await this.page.waitForTimeout(1200)}catch(r){this.log(`Chat header navigation failed: ${r.message}`)}const t=await this.page.evaluate(()=>{const r=y=>((y==null?void 0:y.textContent)||"").trim(),s=y=>{if(!y)return null;const b=y.replace(/[,\s]/g,"").toLowerCase().match(/([0-9.]+)(k|m)?/);if(!b)return null;const L=parseFloat(b[1]);return isNaN(L)?null:b[2]==="k"?Math.round(L*1e3):b[2]==="m"?Math.round(L*1e6):Math.round(L)},l=document.querySelector('[data-testid*="title" i], h1, h2'),a=document.querySelector('img[src*="cdn"], img[alt*="character" i], img[alt*="avatar" i]'),i=document.querySelector('[data-testid*="tagline" i], [class*="tagline" i], [class*="subtitle" i]'),c=Array.from(document.querySelectorAll("*")).find(y=>/by\s+@/i.test(y.textContent||""))||document.querySelector('a[href*="/profile/"]'),g=Array.from(document.querySelectorAll("*")).find(y=>/(today|yesterday|recent)/i.test(y.textContent||""));let u=null,o=null,m=null,x=null;if(c){const y=r(c),f=y.match(/@[^\s•]+/);u=f?f[0]:null,o=y.replace(/by\s+/i,"").trim()||u,c.href&&(m=c.href);const b=c.querySelector("img");b&&(x=b.getAttribute("src")||b.getAttribute("data-src"))}const p=(()=>{const f=[i,c,g,l].filter(Boolean).map(b=>b.textContent||"").join(" ");return s(f||void 0)})(),v=location.pathname.split("/").filter(Boolean).pop()||"unknown";return{displayName:r(l)||null,avatarUrl:a?a.getAttribute("src")||a.getAttribute("data-src"):null,tagline:r(i)||null,creator:u?{handle:u,displayName:o||void 0,avatarUrl:x||void 0,profileUrl:m||void 0}:null,lastSeenLabel:g?r(g):null,interactions:p,chatId:v,url:location.href}});return t.displayName=this.sanitizeText(t.displayName,{field:"chatHeader.displayName",url:e,maxLen:140})||t.displayName,t.tagline=this.sanitizeText(t.tagline,{field:"chatHeader.tagline",url:e,maxLen:220}),t.lastSeenLabel=this.sanitizeText(t.lastSeenLabel,{field:"chatHeader.lastSeenLabel",url:e,maxLen:60}),t.creator&&(t.creator.handle=this.normalizeHandle(this.sanitizeText(t.creator.handle||"",{field:"chatHeader.creator.handle",url:e,maxLen:80})||"")||void 0,t.creator.displayName&&(t.creator.displayName=this.sanitizeText(t.creator.displayName,{field:"chatHeader.creator.displayName",url:e,maxLen:120})||t.creator.displayName),t.creator.profileUrl&&(t.creator.profileUrl=this.sanitizeText(t.creator.profileUrl,{field:"chatHeader.creator.profileUrl",url:e,maxLen:300})||t.creator.profileUrl)),{...t,updatedAt:new Date().toISOString()}}async hydrateCharacterEntries(e,t){var l;const r=(t==null?void 0:t.limit)??e.length,s=[];for(let a=0;a<e.length;a++){const i=e[a],c=!((l=i.creator)!=null&&l.handle),g=!i.avatarUrl,u=!i.tagline;if(!c&&!g&&!u){s.push(i);continue}if(a>=r){s.push(i);continue}try{const o=await this.scrapeChatHeader(i.url);s.push({...i,displayName:o.displayName||i.displayName,avatarUrl:o.avatarUrl||i.avatarUrl,tagline:o.tagline??i.tagline,creator:o.creator||i.creator||null,lastSeenLabel:o.lastSeenLabel??i.lastSeenLabel,interactions:o.interactions??i.interactions,updatedAt:o.updatedAt||new Date().toISOString()})}catch(o){this.log(`Chat hydration failed for ${i.url}: ${o.message}`),s.push(i)}}return s}async hydrateChatsMetadata(e,t){if(!this.page)throw new Error("Browser not launched");const r=(t==null?void 0:t.limit)??e.length,s=[];for(let l=0;l<e.length&&!(t!=null&&t.signal&&t.signal()||l>=r);l++){const a=e[l];try{const i=await this.scrapeChatHeader(a);s.push({...i})}catch(i){this.log(`Hydrate failed for ${a}: ${i.message}`)}await this.page.waitForTimeout(300)}return s}async scrapeProfileCharacters(e,t="most_chats"){if(!this.page)throw new Error("Browser not launched");const r=e.replace(/^@/,""),s=`https://character.ai/profile/${encodeURIComponent(r)}?tab=characters`;try{await this.page.goto(s,{waitUntil:"domcontentloaded",timeout:2e4}),await this.page.waitForTimeout(1e3)}catch(a){this.log(`Profile navigation failed: ${a.message}`)}return(await this.page.evaluate(a=>{const i=p=>((p==null?void 0:p.textContent)||"").trim(),c=p=>{if(!p)return null;const y=p.replace(/[,\s]/g,"").toLowerCase().match(/([0-9.]+)(k|m)?/);if(!y)return null;const f=parseFloat(y[1]);return isNaN(f)?null:y[2]==="k"?Math.round(f*1e3):y[2]==="m"?Math.round(f*1e6):Math.round(f)},g=Array.from(document.querySelectorAll("button, div")).find(p=>(p.textContent||"").toLowerCase().includes("sort"));g&&g.click();const u={most_chats:"Most Chats",alphabetical:"Alphabetical",most_likes:"Most Likes"},o=Array.from(document.querySelectorAll("li, button, div")).find(p=>(p.textContent||"").toLowerCase().includes((u[a]||"").toLowerCase()));o&&o.click();const m=Array.from(document.querySelectorAll('[href*="/chat/"]')).filter(p=>p.href.includes("/chat/")),x=new Map;return m.forEach(p=>{const v=i(p.querySelector("div, span, p"))||"Unknown",y=p.querySelector("img"),f=y?y.getAttribute("src")||y.getAttribute("data-src"):null,b=Array.from(p.querySelectorAll("div, span, p")).find($=>($.textContent||"").length>30&&($.textContent||"").length<180),L=c(p.textContent||void 0),D={characterId:p.href.split("/").filter(Boolean).pop()||null,name:v,avatarUrl:f,tagline:b?i(b):null,interactions:L,creatorHandle:null,profileUrl:p.href,updatedAt:new Date().toISOString()};x.has(p.href)||x.set(p.href,D)}),Array.from(x.values())},t)).map(a=>({...a,name:this.sanitizeText(a.name,{field:"profileCharacters.name",url:s,maxLen:120})||a.name,tagline:this.sanitizeText(a.tagline,{field:"profileCharacters.tagline",url:s,maxLen:220})}))}async scrollListUntilStable(e){if(!this.page)throw new Error("Browser not launched");const t=e.maxRounds??25,r=e.delayMs??700;let s=0,l=0;for(let a=0;a<t&&!(e.signal&&e.signal());a++){const i=await this.page.evaluate(()=>{const u=(()=>{const v=Array.from(document.querySelectorAll("main *")).filter(y=>y.scrollHeight>y.clientHeight+40);return v.sort((y,f)=>f.scrollHeight-f.clientHeight-(y.scrollHeight-y.clientHeight)),v[0]||null})(),o=Array.from(document.querySelectorAll("main a[href]")).length,m=Array.from(document.querySelectorAll('main [role="listitem"], main article, main [data-testid*="card" i]')).length,x=u?u.scrollTop:window.scrollY;return u?u.scrollTop=u.scrollHeight:window.scrollTo(0,document.body.scrollHeight),{anchorCount:o,cardCount:m,before:x,hasContainer:!!u}}),c=Math.max(i.anchorCount,i.cardCount);if(c<=s?l++:l=0,s=c,l>=3)break;await this.page.waitForTimeout(r)}}async indexProfileTab(e,t){if(!this.page)throw new Error("Browser not launched");const r=await this.scrapeViewerProfile().catch(()=>null);if(!(r!=null&&r.handle))throw new Error("Viewer handle unknown; refresh viewer first");const s=r.handle.replace(/^@/,""),l=`https://character.ai/profile/${encodeURIComponent(s)}?tab=${encodeURIComponent(e)}`;await this.page.goto(l,{waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await this.page.waitForTimeout(800),await this.scrollListUntilStable({maxRounds:30,delayMs:800,signal:t==null?void 0:t.signal});const a=await this.page.evaluate(g=>{const u=v=>v.replace(/\r\n/g,`
`).replace(/[\u00a0\t\f\v]/g," ").replace(/\s+/g," ").trim(),o=document.querySelector("main")||document.body,m=Array.from(o.querySelectorAll('[role="listitem"], article, [data-testid*="card" i], [class*="card" i]')),x=new Set,p=[];for(const v of m){const y=u(v.innerText||v.textContent||"");if(!y)continue;const f=v.querySelector("h3")||v.querySelector("h2")||v.querySelector("h4"),b=u((f==null?void 0:f.textContent)||"")||u(y.split(`
`)[0]||"");if(!b)continue;let L=null;const E=(v.innerText||"").split(`
`).map(C=>u(C)).filter(Boolean);E.length>1&&(L=E.slice(1).join(" • ").slice(0,240));const D=v.querySelector("img"),$=D?D.getAttribute("src")||D.getAttribute("data-src"):null,M=`${g}:${b}:${(L||"").slice(0,32)}`;x.has(M)||(x.add(M),g==="voices"?p.push({id:M,displayName:b,description:L||null}):p.push({id:M,displayName:b,description:L||null,avatarUrl:$||null}))}return p},e),i=(t==null?void 0:t.maxItems)??500;if(e==="personas"){const g=[];for(const u of a.slice(0,i)){const o=this.safeText(u.displayName,{field:"personas.displayName",url:l,maxLen:120});o&&g.push({id:String(u.id||`personas:${o}`),displayName:o,description:this.safeText(u.description,{field:"personas.description",url:l,maxLen:240}),avatarUrl:this.safeText(u.avatarUrl,{field:"personas.avatarUrl",url:l,maxLen:300})})}return g}const c=[];for(const g of a.slice(0,i)){const u=this.safeText(g.displayName,{field:"voices.displayName",url:l,maxLen:120});u&&c.push({id:String(g.id||`voices:${u}`),displayName:u,description:this.safeText(g.description,{field:"voices.description",url:l,maxLen:240})})}return c}async scrapeViewerProfile(){var E;if(!this.page)throw new Error("Browser not launched");const e=this.page,t=D=>{this.verboseSanitizeLogs&&this.log(D)},r=D=>{if(!D)return null;const $=D.trim().replace(/^@/,"");if(!$)return null;const M=`@${$}`;return this.isValidHandle(M)?M:null},s=D=>{if(!D)return null;const $=D.match(/\/profile\/([^/?#]+)/i);return $!=null&&$[1]?decodeURIComponent($[1]):null};if(await e.goto("https://character.ai/",{waitUntil:"domcontentloaded"}).catch(()=>{}),await e.waitForTimeout(600),!await e.evaluate(()=>{const D=["log in","sign in","login"];return!Array.from(document.querySelectorAll("a,button")).some(M=>{const C=(M.textContent||"").toLowerCase();return D.some(k=>C.includes(k))})}))return this.log("Viewer scrape: appears logged out (login CTA present)."),null;const a=await e.evaluate(()=>{const $=[document.querySelector("header"),document.querySelector("nav"),document.querySelector('[role="banner"]')].filter(Boolean)[0]||document.body,C=Array.from($.querySelectorAll("a[href]")).find(_=>{const S=_.getAttribute("href")||"";return/\/(profile|user)\//i.test(S)}),k=(C==null?void 0:C.getAttribute("href"))||null;return k?k.startsWith("http")?k:`https://character.ai${k}`:null}),i=r(s(a));i&&t(`[viewer] handle candidate from nav href: ${i}`),a&&(await e.goto(a,{waitUntil:"domcontentloaded",timeout:2e4}).catch(()=>{}),await e.waitForTimeout(700));const c=await e.evaluate(()=>{var Q;const D=H=>H.replace(/\r\n/g,`
`).replace(/[\u00a0\t\f\v]/g," ").replace(/\s+/g," ").trim(),$=document.querySelector("main header")||document.querySelector('[class*="profile" i][class*="header" i]')||document.querySelector("header")||document.querySelector("main")||document.body,M=D($.innerText||$.textContent||""),C=M.match(/@[A-Za-z0-9_]{2,32}/),k=C?C[0]:null,S=((Q=Array.from($.querySelectorAll("a[href]")).find(H=>/\/profile\//i.test(H.getAttribute("href")||"")))==null?void 0:Q.getAttribute("href"))||null,A=S?S.startsWith("http")?S:`https://character.ai${S}`:null,q=$.querySelector("h1")||$.querySelector("h2");let z=q?D(q.textContent||""):null;z||(z=($.innerText||"").split(`
`).map(F=>D(F)).filter(Boolean).find(F=>!/^@[A-Za-z0-9_]{2,32}$/.test(F)&&F.length>1)||null);const V=Array.from($.querySelectorAll("img")).find(H=>{if(!(H.getAttribute("src")||H.getAttribute("data-src")||""))return!1;const F=H.naturalWidth||H.width||0,ee=H.naturalHeight||H.height||0;return F===0||ee===0?!0:F>=32&&ee>=32})||null,G=V?V.getAttribute("src")||V.getAttribute("data-src"):null,B=H=>{const K=new RegExp(`([0-9.,]+\\s*[kKmM]?)\\s*${H}`,"i"),F=M.match(K);return F?F[1].trim():null};return{headerText:M,handleFromHeader:k,displayName:z,avatar:G,followersText:B("followers?"),followingText:B("following"),interactionsText:B("interactions?"),profileUrl:A,url:location.href}}),g=r(((E=e.url().match(/\/profile\/([^/?#]+)/i))==null?void 0:E[1])||null),u=r(s(c.profileUrl||null)),o=this.isValidHandle(c.handleFromHeader||"")?c.handleFromHeader:null,m=g||u||i||o;t(m?`[viewer] handle chosen: ${m} (url=${g?"Y":"N"}, headerHref=${u?"Y":"N"}, navHref=${i?"Y":"N"}, headerText=${o?"Y":"N"})`:`[viewer] handle rejected. candidates: url=${g||"null"} headerHref=${u||"null"} navHref=${i||"null"} headerText=${o||"null"}`);const x=m&&this.isValidHandle(m)?m:null;if(!x)return this.log("Viewer scrape failed: could not extract a valid @handle from profile header/url"),null;const p=this.safeText(c.displayName,{field:"viewer.displayName",url:c.url,maxLen:120}),v=this.safeText(c.avatar,{field:"viewer.avatarUrl",url:c.url,maxLen:300}),y=this.parseCompactNumber(this.safeText(c.followersText,{field:"viewer.followers",url:c.url,maxLen:30})),f=this.parseCompactNumber(this.safeText(c.followingText,{field:"viewer.following",url:c.url,maxLen:30})),b=this.parseCompactNumber(this.safeText(c.interactionsText,{field:"viewer.interactions",url:c.url,maxLen:30}));return p?{handle:x,displayName:p,avatarUrl:v||null,followers:y??null,following:f??null,interactions:b??null,profileUrl:c.url||e.url(),updatedAt:new Date().toISOString(),source:"dom"}:(this.log("Viewer scrape failed: missing displayName in profile header"),null)}async getUserProfile(){return this.scrapeViewerProfile()}async getCreatorProfile(e){if(!this.browserContext)throw new Error("Browser not launched");const t=await this.browserContext.newPage();try{await t.goto(`https://character.ai/profile/${encodeURIComponent(e)}`,{waitUntil:"domcontentloaded",timeout:15e3}),await t.waitForTimeout(500);const r=await t.evaluate(()=>{const l=x=>((x==null?void 0:x.textContent)||"").trim(),a=document.querySelector('img[src*="cdn"], img[alt*="avatar" i]'),i=document.querySelector('[data-testid*="username" i], [class*="username" i], h1, h2'),c=l(i)||null,g=x=>{const p=Array.from(document.querySelectorAll("*")).find(L=>(L.textContent||"").toLowerCase().includes(x));if(!p)return null;const v=(p.textContent||"").match(/([0-9,.kK]+)\s*/);if(!v)return null;const f=v[1].replace(/[,\s]/g,"").toLowerCase().match(/([0-9.]+)(k|m)?/);if(!f)return null;const b=parseFloat(f[1]);return isNaN(b)?null:f[2]==="k"?Math.round(b*1e3):f[2]==="m"?Math.round(b*1e6):Math.round(b)},u=g("follower"),o=g("following"),m=g("interaction")||g("message");return c?{username:c.replace(/^@/,""),avatarUrl:a?a.getAttribute("src")||a.getAttribute("data-src"):null,followers:u??null,following:o??null,interactions:m??null,fetchedAt:new Date().toISOString()}:null});if(!r)return null;const s=this.sanitizeText(r.username,{field:"creatorProfile.username",url:`https://character.ai/profile/${encodeURIComponent(e)}`,maxLen:80});return{...r,username:(s||r.username).replace(/^@/,"")}}catch(r){return this.log(`Creator profile fetch failed for ${e}: ${r.message}`),null}finally{await t.close().catch(()=>{})}}async scrapeChat(e,t){var o;if(!this.page)throw new Error("Browser not launched");this.log(`Navigating to ${e}...`),await this.page.goto(e),await this.page.waitForTimeout(3e3),this.log("Starting scroll-to-top sequence (fingerprint-based)...");const r=new Set;let s=0,l=0;const a=200;let i=!1;const c=m=>{const x=m.url();/graphql|conversation|message/i.test(x)&&(this.log(`[net] ${m.status()} ${x}`),i=!0)};for(this.page.on("response",c);s<5&&l<a;){i=!1;try{await this.page.click("main",{timeout:1e3})}catch{}for(let p=0;p<3;p++)await this.page.keyboard.press("PageUp"),await this.page.waitForTimeout(200);await this.page.evaluate(()=>{const p=Array.from(document.querySelectorAll("div")).find(v=>v.scrollHeight>v.clientHeight+20);p?(p.scrollTop=0,p.scrollTop=40):(window.scrollTo(0,0),window.scrollTo(0,40))});const m=await this.page.evaluate(()=>{const p=[{name:"main-role-log",selector:'main [role="log"]',priority:3},{name:"main-role-feed",selector:'main [role="feed"]',priority:3},{name:"main-aria-message",selector:'main [aria-label*="message" i]',priority:2},{name:"main",selector:"main",priority:1}],v=[{name:"article",selector:"article"},{name:"role-article",selector:'[role="article"]'},{name:"role-listitem",selector:'[role="listitem"]'},{name:"div-has-more",selector:'div:has(button[aria-label*="more" i])'}],y=C=>{const k=C.split(`
`).map(A=>A.trim()).filter(A=>A.length>0),_=/^(Copy|Report|Share|Like|Reply|Menu|More)$/i;return k.filter(A=>!_.test(A)&&A.length>1).join(`
`).trim()},f=p.map(C=>{const k=document.querySelector(C.selector),S=v.map(A=>{const q=k?Array.from(k.querySelectorAll(A.selector)):[];return{selector:A.selector,name:A.name,count:q.length}}).reduce((A,q)=>A+q.count,0);return{container:C.selector,containerName:C.name,priority:C.priority,total:S}}),b=f.filter(C=>C.total>0).sort((C,k)=>k.priority-C.priority||k.total-C.total)[0]||f[0],L=b!=null&&b.container?document.querySelector(b.container):document,E=v.map(C=>({selector:C.selector,name:C.name,nodes:L?Array.from(L.querySelectorAll(C.selector)):[]})).sort((C,k)=>k.nodes.length-C.nodes.length)[0],D=E?E.nodes:[],$=C=>{var A;const k=C.dataset;if(k.isUser==="true"||k.author==="user")return"user";const _=C.textContent||"";if(/\bYou\b/i.test(_))return"user";const S=window.getComputedStyle(C);return S.textAlign==="right"||(A=S.justifyContent)!=null&&A.includes("flex-end")?"user":"char"};return D.map(C=>{const k=y(C.innerText).slice(0,200);return`${$(C)}::${k}`}).filter(Boolean)});let x=0;for(const p of m)r.has(p)||(r.add(p),x++);if(x===0?i?s=0:s++:s=0,this.log(`Scroll cycle ${l+1}: totalSeen=${r.size}, newThisCycle=${x}, netHit=${i}, stagnantCycles=${s}`),s>=5)break;await this.page.evaluate(()=>{const p=Array.from(document.querySelectorAll("div")).find(v=>v.scrollHeight>v.clientHeight+20);p?p.scrollTop=0:window.scrollTo(0,0)}),await this.page.waitForLoadState("networkidle"),await this.page.waitForTimeout(1200),l++}this.page.off("response",c),this.log("Extracting message content...");const g=await this.page.evaluate(()=>{const m=[{name:"main-role-log",selector:'main [role="log"]',priority:3},{name:"main-role-feed",selector:'main [role="feed"]',priority:3},{name:"main-aria-message",selector:'main [aria-label*="message" i]',priority:2},{name:"main",selector:"main",priority:1}],x=[{name:"article",selector:"article"},{name:"role-article",selector:'[role="article"]'},{name:"role-listitem",selector:'[role="listitem"]'},{name:"div-has-more",selector:'div:has(button[aria-label*="more" i])'}],p=S=>{const A=S.split(`
`).map(j=>j.trim()).filter(j=>j.length>0),q=/^(Copy|Report|Share|Like|Reply|Menu|More)$/i;return A.filter(j=>!q.test(j)&&j.length>1).join(`
`).trim()},v=S=>{var j;const A=S.dataset;if(A.isUser==="true"||A.author==="user")return"user";const q=S.textContent||"";if(/\bYou\b/i.test(q))return"user";const z=window.getComputedStyle(S);return z.textAlign==="right"||(j=z.justifyContent)!=null&&j.includes("flex-end")?"user":"char"},y=m.map(S=>{const A=document.querySelector(S.selector),q=x.map(j=>{const V=A?Array.from(A.querySelectorAll(j.selector)):[],G=V.slice(0,2).map(B=>p(B.innerText)).filter(Boolean);return{selector:j.selector,name:j.name,count:V.length,sampleTexts:G}}),z=q.reduce((j,V)=>j+V.count,0);return{container:S.selector,containerName:S.name,priority:S.priority,total:z,messageCounts:q,outerHTML:(A==null?void 0:A.outerHTML)||""}}),f=y.filter(S=>S.total>0).sort((S,A)=>A.priority-S.priority||A.total-S.total)[0]||y[0],b=(f==null?void 0:f.container)||null,L=b?document.querySelector(b):document,E=((f==null?void 0:f.messageCounts)||[]).slice().sort((S,A)=>A.count-S.count)[0],D=(E==null?void 0:E.selector)||x[0].selector,M=Array.from(L?L.querySelectorAll(D):[]).map((S,A)=>{const q=S.innerText,z=p(q);return{turn_index:A,role:v(S),text:z,html:S.innerHTML,top:S.getBoundingClientRect().top}}).filter(S=>S.text&&S.text.trim().length>1),C=[];for(const S of M){const A=C[C.length-1];A&&A.text===S.text&&A.role===S.role||C.push(S)}let k=C;if(C.length>=2){const S=C[0].top;C[C.length-1].top<S&&(k=[...C].reverse())}const _=((f==null?void 0:f.outerHTML)||"").slice(0,500);return{chosenContainer:b,chosenMessageSelector:D,containerResults:y,messages:k.map((S,A)=>({turn_index:A,role:S.role,text:S.text,html:S.html})),containerSnippet:_}});let u=g.messages;return t!=null&&t.reverseTranscript&&(u=[...u].reverse().map((m,x)=>({...m,turn_index:x}))),u.length===0?(this.log(`Extracted 0 messages. Container snippet: ${g.containerSnippet}`),this.log(`Selector counts: ${JSON.stringify((o=g.containerResults)==null?void 0:o.map(m=>({container:m.containerName,total:m.total,counts:m.messageCounts.map(x=>({name:x.name,count:x.count}))})),null,2)}`)):this.log(`Extracted ${u.length} messages.`),u}async testSelectors(){if(!this.page)throw new Error("Browser not launched");const e=await this.page.evaluate(()=>{const t=location.href,r=[{name:"main-role-log",selector:'main [role="log"]',priority:3},{name:"main-role-feed",selector:'main [role="feed"]',priority:3},{name:"main-aria-message",selector:'main [aria-label*="message" i]',priority:2},{name:"main",selector:"main",priority:1}],s=[{name:"article",selector:"article"},{name:"role-article",selector:'[role="article"]'},{name:"role-listitem",selector:'[role="listitem"]'},{name:"div-has-more",selector:'div:has(button[aria-label*="more" i])'}],l=o=>{const m=o.split(`
`).map(v=>v.trim()).filter(v=>v.length>0),x=/^(Copy|Report|Share|Like|Reply|Menu|More)$/i;return m.filter(v=>!x.test(v)&&v.length>1).join(`
`).trim()},a=r.map(o=>{const m=document.querySelector(o.selector),x=s.map(v=>{const y=m?Array.from(m.querySelectorAll(v.selector)):[],f=y.slice(0,2).map(b=>l(b.innerText)).filter(Boolean);return{messageSelector:v.selector,messageName:v.name,count:y.length,sampleTexts:f}}),p=x.reduce((v,y)=>v+y.count,0);return{container:o.selector,containerName:o.name,total:p,priority:o.priority,messageCounts:x}}),i=a.filter(o=>o.total>0).sort((o,m)=>m.priority-o.priority||m.total-o.total)[0]||a[0],c=Array.from(document.querySelectorAll("div")).slice(0,200).map((o,m)=>(o.getBoundingClientRect(),o.scrollHeight>o.clientHeight+20?{idx:m,height:o.scrollHeight,visibleHeight:o.clientHeight}:null)).filter(Boolean),g=c.reduce((o,m)=>m&&(!o||m.height>o.height)?m:o,null),u=Array.from(document.querySelectorAll('a[href*="/chat/"]')).length;return{url:t,selectorResults:a,chosenContainer:i==null?void 0:i.container,scrollCandidates:c,selectedScroll:g,sidebarLinks:u}});return this.log(`Selector test: ${JSON.stringify(e,null,2)}`),e}}function le(){const n=T.resolve(__dirname,"..",".."),e=w.app.getAppPath(),t=[T.join(n,"python","analyzer.py"),T.join(e,"python","analyzer.py"),T.join(process.cwd(),"python","analyzer.py"),T.join(__dirname,"../python","analyzer.py")],r=[];for(const s of t)if(r.push(s),I.existsSync(s))return{scriptPath:s,tried:r};throw new Error(`Unable to locate analyzer.py. Tried:
${r.join(`
`)}`)}function ce(n,e,t){return new Promise((r,s)=>{t(`Starting Python analysis on ${e}...`);const l=ie.spawn("python",[n,e]);let a="";l.stdout.on("data",i=>{const c=i.toString();t(`[Python] ${c}`),a+=c}),l.stderr.on("data",i=>{t(`[Python ERR] ${i.toString()}`)}),l.on("close",i=>{i===0?(t("Analysis complete."),r(a)):s(new Error(`Python script exited with code ${i}`))})})}const X=()=>({exportRootPath:T.join(w.app.getPath("documents"),"CAI_Exports"),lastAccountProfileUrl:null,ui:{theme:"dark",accent:"amber",wallpaper:null},verboseLogs:!1,lastScan:null,userProfile:null});class de{constructor(e){N(this,"baseDir");N(this,"storageDir");N(this,"indexPath");N(this,"settingsPath");N(this,"profileDir");N(this,"characterCachePath");N(this,"sessionPath");N(this,"viewerPath");N(this,"chatsIndexPath");N(this,"charactersIndexPath");N(this,"personasIndexPath");N(this,"voicesIndexPath");this.baseDir=e,this.storageDir=T.join(e,"storage"),this.indexPath=T.join(this.storageDir,"exports-index.json"),this.settingsPath=T.join(this.storageDir,"settings.json"),this.profileDir=process.env.CAI_DUMPER_PROFILE_DIR||T.join(e,"pw-profile"),this.characterCachePath=T.join(this.storageDir,"character-cache.json"),this.sessionPath=T.join(this.storageDir,"session.json"),this.viewerPath=T.join(this.storageDir,"viewer.json"),this.chatsIndexPath=T.join(this.storageDir,"chats-index.json"),this.charactersIndexPath=T.join(this.storageDir,"characters-index.json"),this.personasIndexPath=T.join(this.storageDir,"personas-index.json"),this.voicesIndexPath=T.join(this.storageDir,"voices-index.json"),this.ensureDirs()}getProfileDir(){return this.ensureDirs(),this.profileDir}resetProfileDir(){return I.existsSync(this.profileDir)&&I.rmSync(this.profileDir,{recursive:!0,force:!0}),I.mkdirSync(this.profileDir,{recursive:!0}),this.profileDir}getSettings(){const{data:e,changed:t}=this.readJson(this.settingsPath,X());return t&&this.writeJson(this.settingsPath,e),e}saveSettings(e){const t=this.getSettings(),r={...X(),...t,...e,ui:{...X().ui,...t.ui||{},...e.ui||{}}};return this.writeJson(this.settingsPath,r),r}saveUserProfile(e){const r={...this.getSettings(),userProfile:e};return this.writeJson(this.settingsPath,r),r}getViewer(){const{data:e}=this.readJson(this.viewerPath,null);return e||null}saveViewer(e){this.writeJson(this.viewerPath,e);const t=this.getSettings();return this.writeJson(this.settingsPath,{...t,userProfile:e}),e}saveLastScan(e){const t=new Date().toISOString(),s={...this.getSettings(),lastScan:{at:t,count:e}};return this.writeJson(this.settingsPath,s),s}getExportIndex(){const{data:e,changed:t}=this.readJson(this.indexPath,{exports:[]}),l=(Array.isArray(e.exports)?e.exports:[]).map(i=>this.validateExportEntry(i)).filter(i=>!!i).map(i=>{const c=[];return I.existsSync(i.exportDirAbsolutePath)||c.push("exportDir"),I.existsSync(i.transcriptPath)||c.push("transcript"),I.existsSync(i.metaPath)||c.push("meta"),i.summaryPath&&!I.existsSync(i.summaryPath)&&c.push("summary"),{...i,broken:c.length?c:void 0}}),a={exports:l};return(t||l.length!==e.exports.length)&&this.writeJson(this.indexPath,a),a}recordExport(e){const t=this.getExportIndex(),r=e.id||`${e.chatId}-${Date.parse(e.exportedAt)||Date.now()}`,s={...e,id:r,lastOpenedAt:e.lastOpenedAt||null,broken:void 0},l=t.exports.filter(i=>i.id!==s.id&&i.exportDirAbsolutePath!==s.exportDirAbsolutePath),a={exports:[s,...l].sort((i,c)=>Date.parse(c.exportedAt)-Date.parse(i.exportedAt))};return this.writeJson(this.indexPath,a),s}markOpened(e){const t=this.getExportIndex(),r=new Date().toISOString(),s=t.exports.map(l=>l.id===e?{...l,lastOpenedAt:r}:l);this.writeJson(this.indexPath,{exports:s})}removeEntry(e){const r=this.getExportIndex().exports.filter(s=>s.id!==e);this.writeJson(this.indexPath,{exports:r})}saveCharacterSnapshots(e){this.writeJson(this.characterCachePath,{snapshots:e,savedAt:new Date().toISOString()})}getCharacterSnapshots(){const{data:e}=this.readJson(this.characterCachePath,{snapshots:[]});return Array.isArray(e.snapshots)?e.snapshots:[]}saveChatsIndex(e){this.writeJson(this.chatsIndexPath,{entries:e,savedAt:new Date().toISOString()})}getChatsIndex(){const{data:e}=this.readJson(this.chatsIndexPath,{entries:[]});return Array.isArray(e.entries)?e.entries:[]}saveCharactersIndex(e){this.writeJson(this.charactersIndexPath,{entries:e,savedAt:new Date().toISOString()})}getCharactersIndex(){const{data:e}=this.readJson(this.charactersIndexPath,{entries:[]});return Array.isArray(e.entries)?e.entries:[]}savePersonasIndex(e){this.writeJson(this.personasIndexPath,{entries:e,savedAt:new Date().toISOString()})}getPersonasIndex(){const{data:e}=this.readJson(this.personasIndexPath,{entries:[]});return Array.isArray(e.entries)?e.entries:[]}saveVoicesIndex(e){this.writeJson(this.voicesIndexPath,{entries:e,savedAt:new Date().toISOString()})}getVoicesIndex(){const{data:e}=this.readJson(this.voicesIndexPath,{entries:[]});return Array.isArray(e.entries)?e.entries:[]}clearCaches(){try{I.existsSync(this.characterCachePath)&&I.rmSync(this.characterCachePath,{force:!0})}catch{}const e=this.getSettings();this.writeJson(this.settingsPath,{...e,userProfile:null});try{I.existsSync(this.sessionPath)&&I.rmSync(this.sessionPath,{force:!0})}catch{}try{I.existsSync(this.viewerPath)&&I.rmSync(this.viewerPath,{force:!0})}catch{}}loadSessionSnapshot(){const e=this.defaultSession(),{data:t,changed:r}=this.readJson(this.sessionPath,e),s=this.validateSnapshot(t||e);return r&&this.writeJson(this.sessionPath,s),s}saveSessionSnapshot(e){const t=this.validateSnapshot(e);return this.writeJson(this.sessionPath,t),t}updateSessionSnapshot(e){const t=this.loadSessionSnapshot()||this.defaultSession(),r={...t,...e,viewer:e.viewer!==void 0?e.viewer:t.viewer,characters:e.characters!==void 0?e.characters:t.characters,creators:e.creators!==void 0?e.creators:t.creators,personas:e.personas!==void 0?e.personas:t.personas,voices:e.voices!==void 0?e.voices:t.voices,chats:e.chats!==void 0?e.chats:t.chats,freshness:this.mergeFreshness(t.freshness,e.freshness)};return this.saveSessionSnapshot(r)}markSectionUpdated(e,t){const r=t||new Date().toISOString(),s=this.loadSessionSnapshot()||this.defaultSession(),l={lastUpdated:r,sections:{...s.freshness.sections||{},[e]:r}};return this.saveSessionSnapshot({...s,freshness:l})}validateSnapshot(e){const t=e||this.defaultSession();return{viewer:t.viewer||null,characters:Array.isArray(t.characters)?t.characters:[],creators:t.creators&&typeof t.creators=="object"?t.creators:{},personas:Array.isArray(t.personas)?t.personas:[],voices:Array.isArray(t.voices)?t.voices:[],chats:Array.isArray(t.chats)?t.chats:[],freshness:this.mergeFreshness({lastUpdated:null,sections:{}},t.freshness)}}defaultSession(){return{viewer:null,characters:[],creators:{},personas:[],voices:[],chats:[],freshness:{lastUpdated:null,sections:{}}}}mergeFreshness(e,t){return{lastUpdated:(t==null?void 0:t.lastUpdated)??e.lastUpdated??null,sections:{...e.sections||{},...(t==null?void 0:t.sections)||{}}}}validateExportEntry(e){if(!e||typeof e!="object")return null;const t=["chatId","characterName","exportedAt","exportDirAbsolutePath","messageCount","transcriptPath","metaPath"];for(const r of t)if(!(r in e))return null;return{id:typeof e.id=="string"?e.id:`${e.chatId}-${Date.parse(e.exportedAt)||Date.now()}`,chatId:String(e.chatId),chatUrl:e.chatUrl?String(e.chatUrl):null,characterName:String(e.characterName),characterAvatarUrl:e.characterAvatarUrl??null,viewerHandle:e.viewerHandle?String(e.viewerHandle):null,exportedAt:String(e.exportedAt),createdAt:e.createdAt?String(e.createdAt):null,exportDirAbsolutePath:String(e.exportDirAbsolutePath),messageCount:Number(e.messageCount)||0,summaryPath:e.summaryPath||null,transcriptPath:String(e.transcriptPath),metaPath:String(e.metaPath),tags:Array.isArray(e.tags)?e.tags.map(String):void 0,lastOpenedAt:e.lastOpenedAt?String(e.lastOpenedAt):null,broken:void 0}}ensureDirs(){I.existsSync(this.storageDir)||I.mkdirSync(this.storageDir,{recursive:!0}),I.existsSync(this.profileDir)||I.mkdirSync(this.profileDir,{recursive:!0})}readJson(e,t){try{if(!I.existsSync(e))return{data:t,changed:!0};const r=I.readFileSync(e,"utf-8");return{data:JSON.parse(r),changed:!1}}catch{return{data:t,changed:!0}}}writeJson(e,t){I.mkdirSync(T.dirname(e),{recursive:!0}),I.writeFileSync(e,JSON.stringify(t,null,2),"utf-8")}}process.env.DIST=T.join(__dirname,"../dist");process.env.VITE_PUBLIC=w.app.isPackaged?process.env.DIST:T.join(process.env.DIST,"../public");let d,U=null,h,P=null,R={cancel:!1},J={cancel:!1},W=!1;const Z=5e4;function he(n){if(!n)return null;const e=new Date(n);return Number.isNaN(e.getTime())?null:e.toISOString().slice(0,10)}function ue(n){let e=5381;for(let t=0;t<n.length;t++)e=(e<<5)+e^n.charCodeAt(t);return(e>>>0).toString(16)}function re(n,e){const t=typeof(n==null?void 0:n.text)=="string"?n.text:typeof(n==null?void 0:n.content)=="string"?n.content:String((n==null?void 0:n.text)??(n==null?void 0:n.content)??""),r=String((n==null?void 0:n.role)??(n==null?void 0:n.sender)??(n==null?void 0:n.author)??"").toLowerCase();let s="unknown";r==="user"||r==="viewer"||r==="me"?s="viewer":r==="char"||r==="character"||r==="bot"?s="character":r==="system"&&(s="system");const l=typeof(n==null?void 0:n.timestamp)=="string"?n.timestamp:typeof(n==null?void 0:n.ts)=="string"?n.ts:null,a=typeof(n==null?void 0:n.name)=="string"?n.name:typeof(n==null?void 0:n.author_name)=="string"?n.author_name:null,i=`${l||""}|${s}|${a||""}|${t}|${e}`;return{id:ue(i),ts:l||null,sender:s,name:a,text:t,attachments:Array.isArray(n==null?void 0:n.attachments)?n.attachments:void 0,raw:n}}async function Y(n,e=Z){const t=[];if(!I.existsSync(n))throw new Error(`Transcript not found: ${n}`);const r=I.createReadStream(n,{encoding:"utf-8"});let s="",l=0;const a=[];for await(const g of r){s+=g;let u;for(;(u=s.indexOf(`
`))>=0;){const o=s.slice(0,u);s=s.slice(u+1),l++;const m=o.trim();if(m)try{const x=JSON.parse(m),p=re(x,l);a.push(p),a.length>e&&a.shift()}catch{t.push(`Failed to parse line ${l}`)}}}const i=s.trim();if(i){l++;try{const g=JSON.parse(i),u=re(g,l);a.push(u),a.length>e&&a.shift()}catch{t.push(`Failed to parse line ${l}`)}}const c=l;return c>e&&t.unshift(`Transcript is large (${c} lines). Showing last ${e}.`),{messages:a,warnings:t}}async function pe(n,e=Z){const{messages:t,warnings:r}=await Y(n,e);let s=0,l=0,a=0,i=0;const c={};for(const o of t){s+=o.text.length,l+=o.text.trim()?o.text.trim().split(/\s+/g).length:0,o.sender==="viewer"&&a++,o.sender==="character"&&i++;const m=he(o.ts);m&&(c[m]=(c[m]||0)+1)}const g=t.length,u=Object.keys(c).sort().map(o=>({date:o,count:c[o]}));return{totalMessages:g,viewerMessages:a,characterMessages:i,avgCharsPerMessage:g?s/g:0,avgWordsPerMessage:g?l/g:0,timelineBuckets:u,warnings:r.length?r:void 0}}const ne=process.env.VITE_DEV_SERVER_URL;function fe(){d=new w.BrowserWindow({width:1400,height:900,backgroundColor:"#0f0f11",webPreferences:{preload:T.join(__dirname,"preload.js"),nodeIntegration:!1,contextIsolation:!0}}),ne?d.loadURL(ne):d.loadFile(T.join(process.env.DIST,"index.html"));const n=h.getProfileDir(),e=T.join(n,"cache");U=new oe(n,t=>{d==null||d.webContents.send("scraper-log",t)},e)}w.app.on("window-all-closed",()=>{U&&U.close(),d=null,process.platform!=="darwin"&&w.app.quit()});w.app.whenReady().then(()=>{h=new de(w.app.getPath("userData")),P=h.loadSessionSnapshot();const n=h.getViewer();n&&(P=h.updateSessionSnapshot({viewer:n})),fe()});w.ipcMain.handle("launch-browser",async()=>{if(!U)return!1;await U.launch();try{const n=await U.scrapeViewerProfile();n&&(h==null||h.saveViewer(n),P=h.updateSessionSnapshot({viewer:n}),P=h.markSectionUpdated("viewer"),O())}catch{}return!0});w.ipcMain.handle("fetch-chats",async()=>{if(!U)throw new Error("Scraper not initialized");W=!0;try{const n=await U.scanSidebar();let e=(P==null?void 0:P.viewer)||h.getViewer()||null;try{const r=await U.scrapeViewerProfile();r&&(h.saveViewer(r),e=r)}catch(r){d==null||d.webContents.send("scraper-log",`[Session] Viewer scrape skipped/failed during scan: ${r.message}`)}const t=n.map(r=>({chatId:r.chatId,chatUrl:r.url,characterName:r.displayName,avatarUrl:r.avatarUrl||null,lastSeenLabel:r.lastSeenLabel||r.lastInteractedLabel||null,updatedAt:new Date().toISOString()}));return h.saveCharacterSnapshots(n),h.saveLastScan(n.length),h.saveChatsIndex(t),P=h.updateSessionSnapshot({viewer:e,characters:n}),P=h.markSectionUpdated("characters"),e&&(P=h.markSectionUpdated("viewer")),O(),{viewer:e,chats:t}}finally{W=!1}});w.ipcMain.handle("export-chat",async(n,{url:e,characterName:t,reverseTranscript:r,avatarUrl:s})=>{var E,D;if(!U)throw new Error("Scraper not initialized");const l=await U.scrapeChat(e,{reverseTranscript:r}),a=h==null?void 0:h.getSettings(),i=(a==null?void 0:a.exportRootPath)||T.join(w.app.getPath("documents"),"CAI_Exports"),c=T.join(i,t.replace(/[^a-z0-9]/gi,"_")),g=e.split("/").pop()||"unknown_id",u=T.join(c,g);I.existsSync(u)||I.mkdirSync(u,{recursive:!0});const o={characterName:t,chatId:g,url:e,exportedAt:new Date().toISOString(),messageCount:l.length},m=T.join(u,"transcript.jsonl"),x=l.map($=>JSON.stringify($)).join(`
`);I.writeFileSync(m,x);const p=T.join(u,"transcript.md"),v=`# Chat with ${t}

`+l.map($=>`**${$.role==="user"?"You":t}:**
${$.text}
`).join(`
---

`);I.writeFileSync(p,v);const y=T.join(u,"meta.json");if(I.writeFileSync(T.join(u,"transcript.json"),JSON.stringify(l,null,2)),I.writeFileSync(y,JSON.stringify(o,null,2)),l.length===0){const $="Export produced 0 messages; skipping analysis. Run 'Test selectors' to debug extraction.";return d==null||d.webContents.send("analysis-log",$),{path:u,count:l.length,analysisSkipped:!0,warning:$}}const f=I.existsSync(T.join(u,"summary.md"))?T.join(u,"summary.md"):null,b=((E=h==null?void 0:h.getViewer())==null?void 0:E.handle)||((D=P==null?void 0:P.viewer)==null?void 0:D.handle)||null,L=h==null?void 0:h.recordExport({chatId:g,chatUrl:e,characterName:t,characterAvatarUrl:s||null,viewerHandle:b,exportedAt:o.exportedAt,exportDirAbsolutePath:u,messageCount:l.length,summaryPath:f,transcriptPath:m,metaPath:y,tags:[],lastOpenedAt:null});return d==null||d.webContents.send("export-index-updated",h==null?void 0:h.getExportIndex()),{path:u,count:l.length,analysisSkipped:!1,recorded:L}});w.ipcMain.handle("test-selectors",async()=>{if(!U)throw new Error("Scraper not initialized");return await U.testSelectors()});w.ipcMain.handle("run-analysis",async(n,{folderPath:e})=>{const t=T.join(e,"transcript.jsonl");if(!I.existsSync(t))throw new Error("transcript.jsonl not found in folder");const{scriptPath:r,tried:s}=le();d==null||d.webContents.send("analysis-log",`Using analyzer: ${r}`);const l=await ce(r,t,c=>{d==null||d.webContents.send("analysis-log",c)}),a=T.join(e,"summary.md"),i=T.join(e,"meta.json");try{if(h&&I.existsSync(i)){const c=JSON.parse(I.readFileSync(i,"utf-8")),u=h.getExportIndex().exports.find(o=>o.exportDirAbsolutePath===e);u?(h.recordExport({...u,summaryPath:I.existsSync(a)?a:u.summaryPath}),d==null||d.webContents.send("export-index-updated",h.getExportIndex())):(h.recordExport({chatId:c.chatId||T.basename(e),characterName:c.characterName||"Unknown",characterAvatarUrl:c.avatarUrl||null,exportedAt:c.exportedAt||new Date().toISOString(),exportDirAbsolutePath:e,messageCount:c.messageCount||0,summaryPath:I.existsSync(a)?a:null,transcriptPath:t,metaPath:i,lastOpenedAt:null,tags:[]}),d==null||d.webContents.send("export-index-updated",h.getExportIndex()))}}catch(c){d==null||d.webContents.send("analysis-log",`Index update failed: ${c.message}`)}return l});w.ipcMain.handle("open-folder",(n,e)=>{w.shell.openPath(e)});w.ipcMain.handle("open-path-in-explorer",async(n,e)=>{if(e)try{I.existsSync(e)&&I.statSync(e).isDirectory()?await w.shell.openPath(e):w.shell.showItemInFolder(e)}catch{w.shell.showItemInFolder(e)}});w.ipcMain.handle("open-file",async(n,e)=>{e&&await w.shell.openPath(e)});w.ipcMain.handle("list-exports-for-chat",async(n,e)=>(h.getExportIndex().exports||[]).filter(s=>s.chatId===e).sort((s,l)=>Date.parse(l.exportedAt)-Date.parse(s.exportedAt)));w.ipcMain.handle("read-summary",async(n,e)=>!e||!I.existsSync(e)?"":I.readFileSync(e,"utf-8"));w.ipcMain.handle("read-transcript",async(n,e,t)=>{if(!e)throw new Error("Path is required");const r=I.existsSync(e)&&I.statSync(e).isDirectory()?T.join(e,"transcript.jsonl"):e,{messages:s,warnings:l}=await Y(r,t||Z);return{transcriptPath:r,messages:s,warnings:l}});w.ipcMain.handle("read-transcript-page",async(n,e,t)=>{if(!e)throw new Error("transcriptPath is required");const r=(t==null?void 0:t.direction)||"older",s=Math.max(1,Number(t==null?void 0:t.pageSize)||25e3),l=Math.max(1,Number(t==null?void 0:t.currentMaxLines)||Z);if(r!=="older"){const{messages:g,warnings:u}=await Y(e,l);return{transcriptPath:e,messages:g,warnings:u,maxLines:l,truncated:(u||[]).some(o=>o.includes("Showing last"))}}const a=l+s,{messages:i,warnings:c}=await Y(e,a);return{transcriptPath:e,messages:i,warnings:c,maxLines:a,truncated:(c||[]).some(g=>g.includes("Showing last"))}});w.ipcMain.handle("compute-insights-from-transcript",async(n,e,t)=>pe(e,t||Z));w.ipcMain.handle("get-export-index",async()=>h.getExportIndex());w.ipcMain.handle("get-profile-dir",async()=>h.getProfileDir());w.ipcMain.handle("get-character-cache",async()=>h.getCharacterSnapshots());w.ipcMain.handle("get-user-profile",async()=>h.getViewer()||h.getSettings().userProfile||null);w.ipcMain.handle("get-viewer",async()=>h.getViewer());w.ipcMain.handle("get-session",async()=>(P=h.loadSessionSnapshot(),d==null||d.webContents.send("session-updated",P),P));w.ipcMain.handle("save-session",async(n,e)=>(P=h.updateSessionSnapshot(e),O(),P));w.ipcMain.handle("refresh-viewer-profile",async()=>{if(!U)throw new Error("Scraper not initialized");try{const n=await U.scrapeViewerProfile();if(n)return h.saveViewer(n),P=h.updateSessionSnapshot({viewer:n}),P=h.markSectionUpdated("viewer"),O(),{session:P,profile:n}}catch(n){d==null||d.webContents.send("scraper-log",`[Session] Viewer refresh failed: ${n.message}`)}return{session:P,profile:null}});w.ipcMain.handle("refresh-creator-profiles",async(n,e)=>{if(!U)throw new Error("Scraper not initialized");if(W)throw new Error("[Invariant] Creator hydration attempted during fast scan");R.cancel=!1;const t="creator-hydrate-progress",r=P!=null&&P.creators?{...P.creators}:{},s=f=>/^@[A-Za-z0-9_]{2,32}$/.test(f),l=f=>/^[A-Za-z0-9_]{2,32}$/.test(f),i=(Array.isArray(e)?e:[]).map(f=>(f||"").trim()).filter(Boolean).map(f=>f.startsWith("@")?f:`@${f}`).filter(s).map(f=>f.replace(/^@/,"")).filter(l),c=Array.from(new Set(i));if(c.length===0)return d==null||d.webContents.send(t,{total:0,completed:0}),{session:P,updated:0,message:"No creators to refresh"};const g=3;let u=0,o=0,m=0;const x=Date.now();d==null||d.webContents.send(t,{total:c.length,completed:0,updated:0,failed:0});const p=async f=>{if(!R.cancel)try{const b=await U.getCreatorProfile(f);if(R.cancel)return;b&&(r[f]=b,o++)}catch(b){m++,d==null||d.webContents.send("scraper-log",`[Session] Creator refresh failed for ${f}: ${b.message}`)}finally{u++,d==null||d.webContents.send(t,{total:c.length,completed:u,updated:o,failed:m,cancelled:R.cancel,elapsedMs:Date.now()-x})}},v=[...c],y=Array.from({length:Math.min(g,v.length)}).map(async()=>{for(;v.length&&!R.cancel;){const f=v.shift();if(!f)break;await p(f),await new Promise(b=>setTimeout(b,250))}});return await Promise.all(y),R.cancel?(d==null||d.webContents.send(t,{total:c.length,completed:u,updated:o,failed:m,cancelled:!0}),{session:P,updated:o,message:"Cancelled"}):(P=h.updateSessionSnapshot({creators:r}),P=h.markSectionUpdated("creators"),O(),d==null||d.webContents.send("creators-index-updated",r),{session:P,updated:o,message:o===0?"No creators updated":void 0})});w.ipcMain.handle("refresh-sidebar-scan",async()=>{if(!U)throw new Error("Scraper not initialized");W=!0;try{const n=await U.scanSidebar();let e=(P==null?void 0:P.viewer)||h.getViewer()||null;try{const r=await U.scrapeViewerProfile();r&&(h.saveViewer(r),e=r)}catch(r){d==null||d.webContents.send("scraper-log",`[Session] Viewer scrape skipped/failed during scan: ${r.message}`)}const t=n.map(r=>({chatId:r.chatId,chatUrl:r.url,characterName:r.displayName,avatarUrl:r.avatarUrl||null,lastSeenLabel:r.lastSeenLabel||r.lastInteractedLabel||null,updatedAt:new Date().toISOString()}));return h.saveCharacterSnapshots(n),h.saveLastScan(n.length),h.saveChatsIndex(t),P=h.updateSessionSnapshot({viewer:e,characters:n}),P=h.markSectionUpdated("characters"),e&&(P=h.markSectionUpdated("viewer")),O(),{viewer:e,chats:t}}finally{W=!1}});w.ipcMain.handle("hydrate-chats-metadata",async(n,e,t)=>{if(!U)throw new Error("Scraper not initialized");R.cancel=!1;const r="hydrate-progress",s=await U.hydrateChatsMetadata(e,{limit:t,signal:()=>R.cancel});return R.cancel?(d==null||d.webContents.send(r,{cancelled:!0}),{cancelled:!0,metadata:[]}):(d==null||d.webContents.send(r,{completed:s.length}),{cancelled:!1,metadata:s})});w.ipcMain.handle("cancel-hydrate",async()=>(R.cancel=!0,{cancelled:!0}));w.ipcMain.handle("refresh-characters-from-profile",async(n,e="most_chats")=>{if(!U)throw new Error("Scraper not initialized");const t=h.getViewer()||(P==null?void 0:P.viewer);if(!(t!=null&&t.handle))throw new Error("Viewer handle unknown; refresh viewer first");const r=await U.scrapeProfileCharacters(t.handle,e).catch(s=>(d==null||d.webContents.send("scraper-log",`[Profile] Failed: ${s.message}`),[]));return h.saveCharactersIndex(r),d==null||d.webContents.send("characters-index-updated",r),r});w.ipcMain.handle("get-personas-index",async()=>h.getPersonasIndex());w.ipcMain.handle("get-voices-index",async()=>h.getVoicesIndex());w.ipcMain.handle("refresh-personas-index",async(n,e)=>{if(!U)throw new Error("Scraper not initialized");J.cancel=!1;const t=await U.indexProfileTab("personas",{maxItems:e==null?void 0:e.maxItems,signal:()=>J.cancel});return J.cancel?{cancelled:!0,entries:[]}:(h.savePersonasIndex(t),P=h.updateSessionSnapshot({personas:t}),P=h.markSectionUpdated("personas"),d==null||d.webContents.send("personas-index-updated",t),O(),{cancelled:!1,entries:t})});w.ipcMain.handle("refresh-voices-index",async(n,e)=>{if(!U)throw new Error("Scraper not initialized");J.cancel=!1;const t=await U.indexProfileTab("voices",{maxItems:e==null?void 0:e.maxItems,signal:()=>J.cancel});return J.cancel?{cancelled:!0,entries:[]}:(h.saveVoicesIndex(t),P=h.updateSessionSnapshot({voices:t}),P=h.markSectionUpdated("voices"),d==null||d.webContents.send("voices-index-updated",t),O(),{cancelled:!1,entries:t})});w.ipcMain.handle("cancel-profile-index",async()=>(J.cancel=!0,{cancelled:!0}));w.ipcMain.handle("get-characters-index",async()=>h.getCharactersIndex());w.ipcMain.handle("remove-export-entry",async(n,e)=>(h.removeEntry(e),h.getExportIndex()));w.ipcMain.handle("mark-export-opened",async(n,e)=>(h.markOpened(e),h.getExportIndex()));w.ipcMain.handle("get-settings",async()=>h.getSettings());w.ipcMain.handle("get-chats-index",async()=>h.getChatsIndex());w.ipcMain.handle("save-settings",async(n,e)=>h.saveSettings(e));w.ipcMain.handle("choose-export-root",async()=>{if(!d)throw new Error("Window not ready");const n=await w.dialog.showOpenDialog(d,{properties:["openDirectory"]});if(n.canceled||n.filePaths.length===0)return h.getSettings();const e=n.filePaths[0];return h.saveSettings({exportRootPath:e})});w.ipcMain.handle("reset-browser-profile",async()=>{U==null||U.close(),U=null;const n=h.resetProfileDir();return h.clearCaches(),P=h.loadSessionSnapshot(),O(),{profileDir:n}});function O(){!d||!P||(d.webContents.send("session-updated",P),d.webContents.send("scraper-log","[Session] Saved session snapshot"))}
